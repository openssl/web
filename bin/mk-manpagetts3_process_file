#! /bin/bash -e


F=$1
HERE=$2
series=$3
Dn=$4
Fn=$5
srcdir=$6
destdir=$7

G=$Dn/$Fn.inc
echo "strip-man-html < $srcdir/$F > $destdir/$G"
$HERE/strip-man-html < $srcdir/$F > $destdir/$G

section=$(basename $Dn | sed -e 's|^man||')
description="$($HERE/all-html-man-names < $destdir/$G | sed -e 's|^.* - ||' -e 's|\&|\\\&|g')"
names="$($HERE/all-html-man-names < $destdir/$G | sed -e 's| - .*||' -e 's|, *| |g' -e 's|/|-|g')"
for name in $names; do
    G=$Dn/$name.md.tt
    cat $HERE/../inc/manpage-template.mdtt \
        | sed -E \
                -e "s|\\\$release\\\$|$series|g" \
                -e "s|\\\$sectnum\\\$|$section|g" \
                -e "s|\\\$description\\\$|$description|g" \
                -e "s|\\\$name\\\$|$name|g" \
                -e "s|\\\$origname\\\$|$Fn|g" \
                > $destdir/$G
done